# postinst

## 文件位置

```
# 安装后执行的脚本
/var/lib/dpkg/info/jitsi-videobridge2.postinst
```

## 文件内容

```bash
#!/bin/bash

# jitsi-videobridge安装后执行的脚本。 

set -e

case "$1" in
    configure)

        # 系统属性配置文件：/etc/jitsi/videobridge/config
        CONFIG="/etc/jitsi/videobridge/config"

        # 升级时不希望重新生成配置
        OLDCONFIG="false"

        # 迁移找到的旧配置：/etc/default/jitsi-videobridge重命名为/etc/jitsi/videobridge/config
        if [ -f "/etc/default/jitsi-videobridge" ]; then
            mv /etc/default/jitsi-videobridge $CONFIG
        fi

        # 加载系统属性配置文件：/etc/jitsi/videobridge/config
        if [ -f $CONFIG ]; then
            . $CONFIG
            if [ -n "$JVB_HOSTNAME" ] && [ -n "$JVB_SECRET" ]; then
                OLDCONFIG="true"
            fi
        fi

        # debconf主机名问题
        . /usr/share/debconf/confmodule

        # 获取jitsi-videobridge主机名
        db_get jitsi-videobridge/jvb-hostname
        # jitsi-videobridge主机名
        JVB_HOSTNAME_IN=$(echo "$RET" | xargs echo -n)

        # 全新安装时生成配置，或者所有安装都与现有安装不同时，重新配置
        if [ "$OLDCONFIG" = "false" ] || [ "$JVB_HOSTNAME" != "$JVB_HOSTNAME_IN" ]; then

            JVB_HOSTNAME="$JVB_HOSTNAME_IN"
            if [ "$OLDCONFIG" = "false" ]; then
                # 8个字符的随机密码，替代pwgen 8
                JVB_SECRET=`head -c 8 /dev/urandom | tr '\0-\377' 'a-zA-Z0-9a-zA-Z0-9a-zA-Z0-9a-zA-Z0-9@@@@####'`
            fi
        fi

        # 存储jitsi-videobridge密码，这样，如果xmpp服务器在同一台机器上就可以使用这个密码，
        # 目前每次升级时都这么做，为了能够成功升级旧安装包，否则，只能在第一次生成密码时这么做。
        db_set jitsi-videobridge/jvbsecret $JVB_SECRET

        # debconf完成
        db_stop

        # 旧的jitsi配置：/usr/share/jitsi-videobridge/.sip-communicator/sip-communicator.properties
        OLD_JITSI_CONFIG="/usr/share/jitsi-videobridge/.sip-communicator/sip-communicator.properties"
        # 新的jitsi配置：/etc/jitsi/videobridge/sip-communicator.properties
        NEW_JITSI_CONFIG="/etc/jitsi/videobridge/sip-communicator.properties"
        # jvb配置：/etc/jitsi/videobridge/jvb.conf
        HOCON_CONFIG="/etc/jitsi/videobridge/jvb.conf"

        if [ -f $OLD_JITSI_CONFIG ]; then
            # 如果存在旧的jitsi配置，则重命名为新的jitsi配置
            mv $OLD_JITSI_CONFIG $NEW_JITSI_CONFIG
            echo "# Config has moved to /etc/jitsi/videobridge/
# do not edit this file as it is not used" > ${OLD_JITSI_CONFIG}.old
        elif [ ! -f $NEW_JITSI_CONFIG ]; then
            # 如果sip-communicator.properties文件缺失，则创建这个文件，
            # 因为jvb会搜索这个文件，如果没有创建这个文件，则无法启动
            touch $NEW_JITSI_CONFIG
        fi

        # 检查系统属性配置/etc/jitsi/videobridge/config中是否存在必要的配置，如果缺失，则添加配置：
        # net.java.sip.communicator.SC_HOME_DIR_LOCATION=/etc/jitsi
        # net.java.sip.communicator.SC_HOME_DIR_NAME=videobridge
        # net.java.sip.communicator.SC_LOG_DIR_LOCATION=/var/log/jitsi
        # java.util.logging.config.file=/etc/jitsi/videobridge/logging.properties
        if ! grep -q "JAVA_SYS_PROPS" "$CONFIG"; then
            echo >> $CONFIG
            echo '# adds java system props that are passed to jvb (default are for home and logging config file)' >> $CONFIG
            echo "JAVA_SYS_PROPS=\"-Dnet.java.sip.communicator.SC_HOME_DIR_LOCATION=/etc/jitsi\
 -Dnet.java.sip.communicator.SC_HOME_DIR_NAME=videobridge\
 -Dnet.java.sip.communicator.SC_LOG_DIR_LOCATION=/var/log/jitsi\
 -Djava.util.logging.config.file=/etc/jitsi/videobridge/logging.properties\"" >> $CONFIG
        fi

        # 在系统属性配置/etc/jitsi/videobridge/config中添加配置，使新旧安装都可以开始使用新的配置文件：
        # config.file=/etc/jitsi/videobridge/jvb.conf
        if ! grep -q "\-Dconfig.file" "$CONFIG"; then
            sed -i 's|JAVA_SYS_PROPS="|JAVA_SYS_PROPS="-Dconfig.file='"$HOCON_CONFIG"' |g' $CONFIG
        fi

        # 不使用的旧参数，systemd单元文件无法解析bash变量，这会破坏启动脚本
        sed -i 's/\$JVB_EXTRA_JVM_PARAMS//g' $CONFIG

        # 添加新的jitsi配置：/etc/jitsi/videobridge/sip-communicator.properties
        if ! grep -q "org.ice4j.ice.harvest.STUN_MAPPING_HARVESTER_ADDRESSES" "$NEW_JITSI_CONFIG" \
          && ! grep -q "org.ice4j.ice.harvest.NAT_HARVESTER_PUBLIC_ADDRESS" "$NEW_JITSI_CONFIG" ;then
            echo "org.ice4j.ice.harvest.DISABLE_AWS_HARVESTER=true" >> $NEW_JITSI_CONFIG
            echo "org.ice4j.ice.harvest.STUN_MAPPING_HARVESTER_ADDRESSES=meet-jit-si-turnrelay.jitsi.net:443" >> $NEW_JITSI_CONFIG
        fi

        if ! grep -q "org.jitsi.videobridge.xmpp.user.shard.MUC_JIDS" "$NEW_JITSI_CONFIG" ;then
            echo "org.jitsi.videobridge.ENABLE_STATISTICS=true" >> $NEW_JITSI_CONFIG
            echo "org.jitsi.videobridge.STATISTICS_TRANSPORT=muc" >> $NEW_JITSI_CONFIG
            echo "org.jitsi.videobridge.xmpp.user.shard.HOSTNAME=localhost" >> $NEW_JITSI_CONFIG
            echo "org.jitsi.videobridge.xmpp.user.shard.DOMAIN=auth.$JVB_HOSTNAME" >> $NEW_JITSI_CONFIG
            echo "org.jitsi.videobridge.xmpp.user.shard.USERNAME=jvb" >> $NEW_JITSI_CONFIG
            echo "org.jitsi.videobridge.xmpp.user.shard.PASSWORD=$JVB_SECRET" >> $NEW_JITSI_CONFIG
            echo "org.jitsi.videobridge.xmpp.user.shard.MUC_JIDS=JvbBrewery@internal.auth.$JVB_HOSTNAME" >> $NEW_JITSI_CONFIG
            echo "org.jitsi.videobridge.xmpp.user.shard.MUC_NICKNAME=$(uuidgen)" >> $NEW_JITSI_CONFIG
        fi

        # 添加jvb配置：/etc/jitsi/videobridge/jvb.conf
        if [ ! -f $HOCON_CONFIG ]; then
            echo "Generating an empty hocon config"
            echo "videobridge {
    http-servers {
        public {
            port = 9090
        }
    }
    websockets {
        enabled = true
        domain = \"$JVB_HOSTNAME:443\"
        tls = true
    }
}" >> $HOCON_CONFIG
        fi

        # REST API默认禁用，之前通过--apis来启用，现在在jvb.conf中启用
        if grep -v '^\s*#' /etc/jitsi/videobridge/config | grep -- '--apis=' | grep -i rest >/dev/null 2>&1 ;then
            if ! hocon -f $HOCON_CONFIG get "videobridge.apis.rest.enabled" > /dev/null 2>&1 ;then
                hocon -f $HOCON_CONFIG set "videobridge.apis.rest.enabled" "true"
            fi
            # 从/etc/jitsi/videobridge/config中删除--apis配置，防止不断更新jvb.conf
            sed -i 's/.*--apis.*//' $CONFIG
        fi

        # 使用jitsi用户来启动守护进程，而不是root用户
        if ! getent group jitsi > /dev/null ; then
            groupadd jitsi
        fi
        if ! getent passwd jvb > /dev/null ; then
            useradd -r -g jitsi --shell /bin/bash --create-home -d /usr/share/jitsi-videobridge jvb
        fi
        if ! groups jvb | grep '\bjitsi\b' > /dev/null ; then
            usermod -g jitsi jvb
        fi

        # 创建目录：/usr/share/jitsi-videobridge
        mkdir -p /usr/share/jitsi-videobridge

        # 声明/usr/share/jitsi-videobridge目录，防止被其他用户占用
        OWNER=$(stat -c '%U' /usr/share/jitsi-videobridge)
        GROUP=$(stat -c '%G' /usr/share/jitsi-videobridge)
        if ! dpkg-statoverride --list /usr/share/jitsi-videobridge/* >/dev/null && [ "$OWNER:$GROUP" != "jvb:jitsi" ]; then
            chown -R jvb:jitsi /usr/share/jitsi-videobridge
            OWNER=jvb
            GROUP=jitsi
        fi

        CONFIG_DIR=$(dirname $CONFIG)
        if ! dpkg-statoverride --list "$CONFIG_DIR" >/dev/null; then
            chown -R jvb:jitsi "$CONFIG_DIR"
            chmod 750 "$CONFIG_DIR"
        fi

        # 创建目录：/var/log/jitsi
        if [ ! -d /var/log/jitsi ]; then
            mkdir -p /var/log/jitsi
        fi
        chown $OWNER:$GROUP /var/log/jitsi
        chmod 770 /var/log/jitsi
        ls /var/log/jitsi/jvb* 1>/dev/null 2>&1 && chown -f -R $OWNER:$GROUP /var/log/jitsi/jvb*
        ls /var/log/jitsi/jvb* 1>/dev/null 2>&1 && chmod -f -R 640 /var/log/jitsi/jvb*

        # 确保没有运行jitsi-videobridge2服务，最后启动jitsi-videobridge2服务
        if [ -d /run/systemd/system ]; then
            systemctl stop jitsi-videobridge2.service >/dev/null || true
        fi

        # 删除旧的jvb组
        if getent group jvb > /dev/null; then
            groupdel jvb
        fi

        # 加载JVB需要的UDP缓冲区大小。
        # 正如https://github.com/jitsi/jitsi-videobridge/issues/461中所描述的，
        # OpenVZ容器通常不允许使用sysctl配置值来修改kernel。
        sysctl --system || true

    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb将会使用其他debhelper脚本自动生成的shell代码来替换这个。

# dh_installsystemd/12.10ubuntu1自动生成的部分
if [ "$1" = "configure" ] || [ "$1" = "abort-upgrade" ] || [ "$1" = "abort-deconfigure" ] || [ "$1" = "abort-remove" ] ; then
	# 只会删除在安装包删除时d-s-h创建的掩码
	deb-systemd-helper unmask 'jitsi-videobridge2.service' >/dev/null || true

	# was-enabled默认为true，因此新的安装会运行enable
	if deb-systemd-helper --quiet was-enabled 'jitsi-videobridge2.service'; then
		# 第一次安装时启用服务单元，如果服务单元文件已经变化，则在升级时创建新的符号链接
		deb-systemd-helper enable 'jitsi-videobridge2.service' >/dev/null || true
	else
		# 更新状态文件以添加新的符号链接（如果存在），需要在purge时清理，并且删除旧的符号链接。
		deb-systemd-helper update-state 'jitsi-videobridge2.service' >/dev/null || true
	fi
fi
# 自动生成的部分结束
# dh_installsystemd/12.10ubuntu1自动生成的部分
if [ "$1" = "configure" ] || [ "$1" = "abort-upgrade" ] || [ "$1" = "abort-deconfigure" ] || [ "$1" = "abort-remove" ] ; then
	if [ -d /run/systemd/system ]; then
		systemctl --system daemon-reload >/dev/null || true
		if [ -n "$2" ]; then
			_dh_action=restart
		else
			_dh_action=start
		fi
		deb-systemd-invoke $_dh_action 'jitsi-videobridge2.service' >/dev/null || true
	fi
fi
# 自动生成的部分结束
# dh_installsystemd/12.10ubuntu1自动生成的部分
if [ "$1" = "configure" ] || [ "$1" = "abort-upgrade" ] || [ "$1" = "abort-deconfigure" ] || [ "$1" = "abort-remove" ] ; then
	# 只会删除在安装包删除时d-s-h创建的掩码
	deb-systemd-helper unmask 'jitsi-videobridge2.service' >/dev/null || true

	# was-enabled默认为true，因此新的安装会运行enable
	if deb-systemd-helper --quiet was-enabled 'jitsi-videobridge2.service'; then
		# 第一次安装时启用服务单元，如果服务单元文件已经变化，则在升级时创建新的符号链接
		deb-systemd-helper enable 'jitsi-videobridge2.service' >/dev/null || true
	else
		# 更新状态文件以添加新的符号链接（如果存在），需要在purge时清理，并且删除旧的符号链接。
		deb-systemd-helper update-state 'jitsi-videobridge2.service' >/dev/null || true
	fi
fi
# 自动生成的部分结束
# dh_installsystemd/12.10ubuntu1自动生成的部分
if [ "$1" = "configure" ] || [ "$1" = "abort-upgrade" ] || [ "$1" = "abort-deconfigure" ] || [ "$1" = "abort-remove" ] ; then
	if [ -d /run/systemd/system ]; then
		systemctl --system daemon-reload >/dev/null || true
		if [ -n "$2" ]; then
			_dh_action=restart
		else
			_dh_action=start
		fi
		deb-systemd-invoke $_dh_action 'jitsi-videobridge2.service' >/dev/null || true
	fi
fi
# 自动生成的部分结束

exit 0
```
